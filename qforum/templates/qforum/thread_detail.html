{% extends "qforum/forum_base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block extrahead %}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="{% static '/qforum/js/forum_detail.js'%}"></script>
<script src="{% static '/qforum/js/forum_list.js'%}"></script>
{% endblock extrahead%}
{% block details %}
<div class="col-md-10 mt-5 ms-5 ps-4 py-2 bg-light left-border">
    <img class="rounded-circle article-img profile-img" src="{{ thread.name.user_profile.image.url }}">
    <a class="text-black" href="{% url 'profile' %}"> {{thread.name}}</a>
    <span class="op-6 text-muted">| {{ thread.created_on|timesince }} ago</span>
    <span class="d-inline-block text-sm text-muted mx-3"><i class="fa-solid fa-comments"></i>
        Comments: {{comments.all.count}}</span>
    <h5 class="text-primary px-3">{{thread.id}}. {{ thread.topic}}</h5>
    <p class="px-3"> {{thread.description|safe}} </p>
    <!-- Vote ajax -->
    <div class="col-1 d-inline-block" id="up-votes" data-value="{{thread.slug}}">
        <a class="btn voting-up" value="voteup" role="button">
            <i class="fa-solid fa-caret-up text-success"></i>
            <span id="num-up-votes">{{ thread.no_of_upvotes }}</span>
        </a>
    </div>
    <div class="col-1 d-inline-block" id="down-votes" data-value="{{thread.slug}}">
        <a class="btn voting-down" value="votedown" role="button">
            <i class="fa-solid fa-caret-down text-danger"></i>
            <span id="num-down-votes">{{ thread.no_of_downvotes }}</span>
        </a>
    </div>
    <!-- End ajax vote-->
    <button class="btn" data-bs-toggle="modal" data-bs-target="#addCommentModal-{{thread.id}}">Comment <i class="fa-solid fa-angle-down"></i></button>
    {% if request.user == thread.name %}
    <a href="{% url 'qforum:edit-thread' thread.slug %}" class="op-6 px-3 text-muted"><i class="fa-solid fa-pen-to-square"></i></a>
    <a href="{% url 'qforum:delete-thread' thread.slug %}" class="op-6 text-muted"><i class="fa-solid fa-trash small"></i></a>
    {% endif %}

    <!-- Ajax comment -->
    <!--  <div class="alert alert-success" role="alert">
        Your comment has been submitted successfully
    </div> -->
    <div class="modal fade bg-light-green add-comment-modal" id="addCommentModal-{{thread.id}}" data-value="addCommentModal-{{thread.id}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                {% if user.is_authenticated %}
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Commenting as {{request.user.username}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" autocomplete="off" id="comment-form" class="comment-form commenting" data-parent="" data-thread="{{thread.id}}">
                        {% csrf_token %}
                        {{ comment_form.content }}
                        <button type="submit" class="btn btn-primary mt-2">Submit</button>
                    </form>
                </div>
                {% else %}
                <h2>You need to Login to comment</h2>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- End ajax comment -->

    {% for comment in comments %}
    {% if not comment.parent %}
    <div class="py-2 shadow border-bottom" id="comment-box">
        <div id="comment-box">
            <a class="text-black" href="{% url 'profile' %}">
                {% if comment.name.profile.image %}
                <img class="rounded-circle article-img profile-img" src="{{ comment.name.user_profile.image.url }}">
                {% else %}
                <img class="rounded-circle article-img profile-img" src="{% get_media_prefix %}default.jpg">
                {% endif %}
                {{comment.name}}</a>
            <span class="op-6 text-muted">{{ comment.created|timesince }} ago</span>
            {% if request.user == comment.name %}
            <span class="op-6 px-3 text-muted"><i class="fa-solid fa-pen-to-square"></i></span>
            <span class="op-6 text-muted"><i class="fa-solid fa-trash small"></i></span>
            {% endif %}
            <p class="px-3 mt-2">{{comment.content}}</p>

            <!-- Like unlike ajax -->
            <div class="col-1 d-inline-block" id="likes" data-value="{{comment.id}}">
                <a class="btn liking" value="like" role="button">
                    <i class="fa-solid fa-thumbs-up"></i>
                    <span id="num-likes">{{ comment.no_of_likes }}</span>
                </a>
            </div>
            <div class="col-1 d-inline-block" id="dislikes" data-value="{{comment.id}}">
                <a class="btn disliking" value="dislike" role="button">
                    <i class="fa-solid fa-thumbs-down"></i>
                    <span id="num-dislikes">{{ comment.no_of_dislikes }}</span>
                </a>
            </div>
            <!-- End ajax like unlike-->

            <!-- Ajax reply -->
            {% if user != comment.name %}
            <button class="btn btn-sm d-inline-block" data-bs-toggle="collapse" data-bs-target="#comment-form-{{comment.id}}" aria-controls="comment-form-{{comment.id}}">
                <i class="fa-solid fa-comment text-muted"></i> <span>Reply</span></button>
            <div class="form-box collapse ms-3" id="comment-form-{{comment.id}}">
                {% if user.is_authenticated %}
                <p class="modal-title" id="exampleModalLabel">Replying as {{request.user.username}}</p>
                <form method="POST" action="" autocomplete="off" id="reply-form" class="comment-form replying" data-parent="{{comment.id}}" data-thread="{{thread.id}}">
                    {% csrf_token %}
                    {{ comment_form.content }}
                    <button type="submit" class="btn btn-primary mt-3" data-bs-toggle="collapse" data-bs-target="#comment-form-{{comment.id}}">Submit</button>
                </form>
                {% else %}
                <h2>You need to Login to comment</h2>
                {% endif %}
            </div>
            {% endif %}
            <!-- End ajax reply -->

            {% if comment.is_parent %}
            {% load reply_tree %}
            {% reply_tree%}
            {% endif %}
            {% endif%}
            {% endfor %}
        </div>
    </div>
</div>

<script type="text/javascript">
    const commentForm = document.getElementsByClassName('comment-form')
    $(document).ready(function() {
        for (let form of commentForm) {
            form.addEventListener('submit', e => {
                e.preventDefault();
                const commentBox = document.getElementById('comment-box');
                var replyBox = document.getElementById('reply-box');
                var content = form.getElementsByTagName('textarea')[0];
                var pk = form.getAttribute('data-thread');
                console.log(pk);
                var parent = form.getAttribute('data-parent');

                $.ajax({
                    type: 'POST',
                    url: url,
                    data: {
                        'csrfmiddlewaretoken': csrftoken,
                        content: content.value,
                        parent: parent,
                        pk: pk,
                    },
                    success: function(response) {
                        if (parent == 0) {
                            commentBox.insertAdjacentHTML('afterbegin', `
                <a class="text-black" href="{% url 'profile' %}">
                <img class="rounded-circle article-img profile-img" src="${response.profile}">
                ${response.name}</a>
              <span class="op-6 text-muted">${response.created}</span>
              {% if request.user == comment.name %}
              <span class="op-6 px-3 text-muted"><i class="fa-solid fa-pen-to-square"></i></span>
              <span class="op-6 text-muted"><i class="fa-solid fa-trash small"></i></span>
              {% endif %}
              <p class="px-3 mt-2"> ${response.content}</p>
              <div class="col-1 d-inline-block" id="likes" data-value="${response.pk}">
                <a class="btn liking" value="like" role="button">
                    <i class="fa-solid fa-thumbs-up"></i>
                    <span id="num-likes">${response.likes}</span>
                </a>
              </div>
              <div class="col-1 d-inline-block" id="dislikes" data-value="${response.pk}">
                <a class="btn disliking" value="dislike" role="button">
                    <i class="fa-solid fa-thumbs-down"></i>
                    <span id="num-dislikes">${response.dislikes}</span>
                </a>
              </div>
              {% if user != comment.name %}
              <button class="btn btn-sm d-inline-block" data-bs-toggle="collapse" data-bs-target="#reply-form-${response.pk}" aria-controls="reply-form-${response.pk}">
                <i class="fa-solid fa-comment text-muted"></i> <span>Reply</span></button>
              {% endif %}
               `);
                            $('.add-comment-modal').modal('hide');
                        } else {
                            form.closest('.form-box').insertAdjacentHTML('afterend', `
                            <div>
            <a class="text-black" href="#">
                {% if comment.name.profile.image %}
                <img class="rounded-circle article-img profile-img" src="{{ comment.name.user_profile.image.url }}">
                {% else %}
                <img class="rounded-circle article-img profile-img" src="{% get_media_prefix %}default.jpg">
                {% endif %}
                ${response.name}</a>
            <span class="op-6 text-muted">${response.created}</span>
            {% if request.user == comment.name %}
            <span class="op-6 px-3 text-muted"><i class="fa-solid fa-pen-to-square"></i></span>
            <span class="op-6 text-muted"><i class="fa-solid fa-trash small"></i></span>
            {% endif %}
            <p class="px-3 mt-2">${response.content}</p>
            <!-- Like unlike ajax -->
            <div class="col-1 d-inline-block" id="likes" data-value="{{comment.id}}">
                <a class="btn liking" value="like" role="button">
                    <i class="fa-solid fa-thumbs-up"></i>
                    <span id="num-likes">{{ comment.no_of_likes }}</span>
                </a>
            </div>
            <div class="col-1 d-inline-block" id="dislikes" data-value="{{comment.id}}">
                <a class="btn disliking" value="dislike" role="button">
                    <i class="fa-solid fa-thumbs-down"></i>
                    <span id="num-dislikes">{{ comment.no_of_dislikes }}</span>
                </a>
            </div>
            {% if user != comment.name %}
            <button class="btn btn-sm d-inline-block" data-bs-toggle="collapse" data-bs-target="#reply-form-{{comment.id}}" aria-controls="reply-form-{{comment.id}}">
                <i class="fa-solid fa-comment text-muted"></i> <span>Reply</span></button>
            {% endif %}
            <div class="form-box collapse ms-3" id="reply-form-{{comment.id}}">
                {% if user.is_authenticated %}
                <p class="modal-title" id="exampleModalLabel">Replying as {{request.user.username}}</p>
                <form method="POST" action="" autocomplete="off" class="comment-form" data-parent="{{comment.id}}" data-thread="{{comment.thread.id}}">
                    {% csrf_token %}
                    {{ comment_form.content }}
                    <button type="submit" class="btn btn-primary mt-3">Submit</button>
                </form>
                {% else %}
                <h2>You need to Login to comment</h2>
                {% endif %}
            </div>
            {% if comment.replies.count > 0 %}
            {% load reply_tree %}
            {% reply_tree%}
            {% endif %}
        </div>
        `);
                        }
                        $('.form-box').modal('hide');
                        form.reset();
                    },
                    error: function(error) {
                        console.log('Error: ', error);
                    },
                });
            });
        }
    });
</script>
{% endblock details %}

{% block footer %}
{% include 'footer.html' %}
{% endblock footer %}