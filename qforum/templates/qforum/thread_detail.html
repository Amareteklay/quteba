{% extends "qforum/forum_base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block details %}
<div class="col-md-10 ms-5 bg-light">
    <div class="row mb-5">
        <div class="col-md-11 bg-white mx-5 me-5">
            <img class="rounded-circle article-img profile-img" src="{{ thread.name.user_profile.image.url }}">
            <a class="text-black" href="#"> {{thread.name}}</a>
            <span class="op-6 text-muted">| {{ thread.created_on|timesince }} ago</span>
            <span class="d-inline-block text-sm text-muted mx-3"><i class="fa-solid fa-comments"></i> {{comments.all.count}}</span>
            <h5 class="text-primary">{{ thread.topic}}</h5>
            <p> {{thread.description|safe}} </p>
            <!-- Vote up -->
            <form method="POST" class="d-inline-block" action="{% url 'qforum:thread-vote-up' thread.id %}">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.path }}">
                <button class="remove-default-btn text-muted border-0 bg-white d-inline-block" type="submit">
                    <i class="fa-solid fa-caret-up"></i>
                </button>
                {% if thread.no_of_upvotes %}
                <span>{{ thread.no_of_upvotes }}</span>
                {% endif %}
            </form>
            <!-- Vote down -->
            <form method="POST" class="d-inline-block" action="{% url 'qforum:thread-vote-down' thread.id %}">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.path }}">
                <button class="remove-default-btn text-muted border-0 bg-white d-inline-block" type="submit">
                    <i class="fa-solid fa-caret-down"></i>
                </button>
                {% if thread.no_of_downvotes %}
                <span>{{ thread.no_of_downvotes }}</span>
                {% endif %}
            </form>
            <h4 id="comment-form" class="btn btn-light d-inline-block" data-bs-toggle="collapse" data-bs-target="#comment-form-{{thread.id}}" aria-controls="comment-form-{{thread.id}}">Comment <i class="fa-solid fa-angle-down"></i></h4>
            {% if request.user == thread.name %}
            <a href="{% url 'qforum:edit-thread' thread.slug %}" class="op-6 px-3 text-muted"><i class="fa-solid fa-pen-to-square"></i></a>
            <a href="{% url 'qforum:delete-thread' thread.slug %}" class="op-6 text-muted"><i class="fa-solid fa-trash small"></i></a>
            {% endif %}
        </div>
        <div class="collapse ms-4 ps-4" id="comment-form-{{thread.id}}">
            {% if user.is_authenticated %}
            <form method="POST" action="{% url 'qforum:thread_detail' thread.slug %}">
                {% csrf_token %}
                {{ comment_form.content }}
                <button type="button" onclick="hideForm()" class="btn btn-light border btn-sm">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
            {% else %}
            <h2>You need to Login to comment</h2>
            {% endif %}
        </div>
        {% for comment in comments %}
        {% if not comment.parent %}
        <div class="row gx-0">
            <div class="col-md-12 ms-4 ps-4">
                <a class="text-black" href="#">
                    {% if comment.name.profile.image %}
                    <img class="rounded-circle article-img profile-img" src="{{ comment.name.profile.image.url }}">
                    {% else %}
                    <img class="rounded-circle article-img profile-img" src="{% get_media_prefix %}default.jpg">
                    {% endif %}
                    {{comment.name}}</a>
                <span class="op-6 text-muted">{{ comment.created|timesince }} ago</span>
                {% if request.user == comment.name %}
                <span class="op-6 px-3 text-muted"><i class="fa-solid fa-pen-to-square"></i></span>
                <span class="op-6 text-muted"><i class="fa-solid fa-trash small"></i></span>
                {% endif %}
                <div class="left-indent border-bottom me-0 pe-0">
                    <p class="px-3 mt-2"> {{comment.content}}</p>
                    <div class="row gx-0 mx-0 px-0">
                        <div class="col-md-12 ps-3">
                            <form method="POST" class="d-inline-block" action="{% url 'qforum:comment-like' thread.slug comment.pk%}">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.path }}">
                                <button class="remove-default-btn text-muted border-0 bg-white d-inline-block pe-1" type="submit">
                                    <i class="fa-regular fa-thumbs-up"> </i>
                                </button>
                                {% if comment.no_of_likes %}
                                <span>{{ comment.no_of_likes }}</span>
                                {% endif %}
                            </form>
                            <form method="POST" class="d-inline-block" action="{% url 'qforum:comment-dislike' thread.slug comment.pk %}">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.path }}">
                                <button class="remove-default-btn text-muted border-0 bg-white d-inline-block pe-1" type="submit">
                                    <i class="far fa-thumbs-down"> <span>{{ comment.dislikes.all.count }}</span></i>
                                </button>
                                {% if comment.no_of_dislikes %}
                                <span>{{ comment.no_of_dislikes }}</span>
                                {% endif %}
                            </form>
                            {% if user != comment.name %}
                            <button class="btn btn-sm d-inline-block" data-bs-toggle="collapse" data-bs-target="#reply-form-{{comment.id}}" aria-controls="reply-form-{{comment.id}}">
                                <i class="fa-solid fa-comment text-muted"></i> <span>Reply</span></button>
                        </div>
                        {% endif %}
                        <div class="col-md-1"></div>
                    </div>
                    <div class="collapse ms-3" id="reply-form-{{comment.id}}">
                        {% if user.is_authenticated %}
                        <form method="POST" action="{% url 'qforum:reply' thread.slug comment.id %}">
                            {% csrf_token %}
                            {{ comment_form.content }}
                            <button type="button" onclick="hideForm()" class="btn btn-light border btn-sm mt-3">Cancel</button>
                            <button type="submit" class="btn btn-primary mt-3">Submit</button>
                        </form>
                        {% else %}
                        <h2>You need to Login to comment</h2>
                        {% endif %}
                    </div>
                    {% if comment.is_parent %}
                    {% load reply_tree %}
                    {% reply_tree%}
                    {% endif %}
                </div>
                {% endif%}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock details %}